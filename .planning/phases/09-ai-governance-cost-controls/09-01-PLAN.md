---
phase: 09-ai-governance-cost-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - projects/web_api/web_api/main.py
  - projects/web_api/web_api/models/responses.py
  - projects/agents/agents/main.py
  - projects/agents/agents/tasks/validate.py
  - projects/agents/agents/tasks/reporting_agent.py
  - projects/agents/agents/schemas.py
  - projects/web_api/tests/test_ai_policy_contracts.py
  - projects/agents/tests/test_ai_policy_modes.py
files-modified: [projects/web_api/web_api/main.py, projects/web_api/web_api/models/responses.py, projects/agents/agents/main.py, projects/agents/agents/tasks/validate.py, projects/agents/agents/tasks/reporting_agent.py, projects/agents/agents/schemas.py, projects/web_api/tests/test_ai_policy_contracts.py, projects/agents/tests/test_ai_policy_modes.py]
autonomous: true
objective: "Expose confidence-aware AI policy context and explicit operator override controls for synthesis and triage outputs."
requirements:
  - AI-01
user_setup: []
must_haves:
  truths:
    - "AI synthesis and triage contracts expose confidence-aware policy mode instead of opaque, confidence-free output."
    - "Operator override requests are explicitly represented in output metadata (requested/applied/reason/source) and preserved through execution flow."
    - "Governance contract changes are backward-compatible for existing keys consumed by reporting and auth/health surfaces."
  artifacts:
    - path: "projects/web_api/web_api/models/responses.py"
      provides: "typed policy-context response fields for synthesis/triage governance metadata"
    - path: "projects/web_api/web_api/main.py"
      provides: "API route behavior that accepts/returns policy-mode and operator override contract data"
    - path: "projects/agents/agents/tasks/validate.py"
      provides: "deterministic confidence-to-policy mapping and override-aware triage result behavior"
    - path: "projects/agents/agents/tasks/reporting_agent.py"
      provides: "synthesis metadata carrying confidence-aware policy context"
    - path: "projects/web_api/tests/test_ai_policy_contracts.py"
      provides: "web_api regression tests locking AI policy/override contract and backward compatibility"
      min_lines: 80
    - path: "projects/agents/tests/test_ai_policy_modes.py"
      provides: "agents regression tests for confidence-policy mapping and override handling"
      min_lines: 70
  key_links:
    - from: "projects/agents/agents/tasks/validate.py"
      to: "projects/agents/agents/main.py"
      via: "triage workflow inserts outputs using policy-mode/override-aware result contract"
    - from: "projects/agents/agents/tasks/reporting_agent.py"
      to: "projects/web_api/web_api/main.py"
      via: "synthesis metadata produced by agents is forwarded through web_api response contract"
    - from: "projects/web_api/web_api/main.py"
      to: "projects/web_api/web_api/models/responses.py"
      via: "route handlers return typed policy-context output models"
    - from: "projects/web_api/tests/test_ai_policy_contracts.py"
      to: "projects/web_api/web_api/main.py"
      via: "tests assert policy-context and operator override contract stability"
---

<objective>
Expose confidence-aware AI policy context and explicit operator override controls for synthesis and triage outputs.

Purpose: satisfy AI-01 by making AI decisions transparent and controllable without breaking existing reporting/triage flows.
Output: response contracts + route handling + agent policy mapping + regression coverage.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/09-ai-governance-cost-controls/09-RESEARCH.md
@projects/web_api/web_api/main.py
@projects/web_api/web_api/models/responses.py
@projects/agents/agents/main.py
@projects/agents/agents/tasks/validate.py
@projects/agents/agents/tasks/reporting_agent.py
@projects/agents/agents/schemas.py
@projects/web_api/tests/test_llm_auth_status.py
@projects/agents/tests/test_model_manager_modes.py
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Add typed AI policy-context contract fields for synthesis and triage outputs</name>
  <files>projects/web_api/web_api/models/responses.py, projects/web_api/web_api/main.py, projects/agents/agents/schemas.py</files>
  <action>Extend response schemas and API contracts to include confidence-aware policy metadata (`policy_mode`, confidence score/band, override metadata object) while preserving existing response keys consumed by current reporting pages and clients.</action>
  <verify>cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_llm_auth_status.py -q && cd /opt/Nemesis && rg -n "policy_mode|override|confidence" projects/web_api/web_api/models/responses.py projects/web_api/web_api/main.py projects/agents/agents/schemas.py</verify>
  <done>AI response contracts expose policy/override context in a backward-compatible typed schema.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Implement deterministic confidence-policy mapping and override preservation in agents flow</name>
  <files>projects/agents/agents/tasks/validate.py, projects/agents/agents/tasks/reporting_agent.py, projects/agents/agents/main.py, projects/agents/tests/test_ai_policy_modes.py</files>
  <action>Add deterministic policy-mode derivation from confidence signals and explicit operator override propagation (requested/applied/reason/source) for both triage and synthesis pathways, including fail-safe metadata when model/auth dependencies are unavailable.</action>
  <verify>cd /opt/Nemesis/projects/agents && uv run pytest tests/test_ai_policy_modes.py tests/test_model_manager_modes.py -q</verify>
  <done>Agent outputs consistently carry confidence-aware policy mode and override state under healthy and degraded conditions.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Lock AI-01 governance behavior with web_api regression tests</name>
  <files>projects/web_api/tests/test_ai_policy_contracts.py, projects/web_api/web_api/main.py, projects/web_api/web_api/models/responses.py</files>
  <action>Add web_api regression tests that verify policy metadata presence, override field persistence, fallback behavior when agents dependencies fail, and backward compatibility of legacy synthesis keys (`success`, `risk_level`, `token_usage`, `report_markdown`).</action>
  <verify>cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_ai_policy_contracts.py tests/test_llm_auth_status.py -q</verify>
  <done>AI-01 contract behavior is regression-locked and fails safely when dependencies are unavailable.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd /opt/Nemesis/projects/agents && uv run pytest tests/test_ai_policy_modes.py tests/test_model_manager_modes.py -q` passes
- [ ] `cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_ai_policy_contracts.py tests/test_llm_auth_status.py -q` passes
- [ ] `cd /opt/Nemesis && rg -n "policy_mode|override|confidence" projects/web_api/web_api/main.py projects/web_api/web_api/models/responses.py projects/agents/agents/tasks/validate.py projects/agents/agents/tasks/reporting_agent.py` confirms governance contract wiring
- [ ] AI-01 evidence recorded: synthesis/triage outputs expose confidence-aware policy mode and explicit operator override controls
</verification>

<success_criteria>

- AI-01 is satisfied with explicit, typed governance context for AI synthesis/triage outputs
- Operator overrides are preserved in output metadata and remain auditable in degraded/fallback paths
- Existing response consumers remain compatible with legacy keys and semantics

</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-governance-cost-controls/09-01-SUMMARY.md`
</output>
