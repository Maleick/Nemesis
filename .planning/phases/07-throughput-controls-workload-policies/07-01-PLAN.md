---
phase: 07-throughput-controls-workload-policies
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - projects/file_enrichment/file_enrichment/subscriptions/file.py
  - projects/document_conversion/document_conversion/workflow_manager.py
  - projects/web_api/web_api/main.py
  - projects/web_api/web_api/models/responses.py
  - projects/web_api/tests/test_workflow_observability.py
  - projects/web_api/tests/test_throughput_policy_status.py
  - projects/file_enrichment/tests/test_queue_pressure_policies.py
  - projects/document_conversion/tests/test_workflow_manager_policy.py
files-modified: [projects/file_enrichment/file_enrichment/subscriptions/file.py, projects/document_conversion/document_conversion/workflow_manager.py, projects/web_api/web_api/main.py, projects/web_api/web_api/models/responses.py, projects/web_api/tests/test_workflow_observability.py, projects/web_api/tests/test_throughput_policy_status.py, projects/file_enrichment/tests/test_queue_pressure_policies.py, projects/document_conversion/tests/test_workflow_manager_policy.py]
autonomous: true
objective: "Implement queue-pressure-first throughput policy behavior with profile presets, sustained+cooldown semantics, fail-safe conservative mode, and API status contracts."
requirements:
  - SCALE-01
user_setup: []
must_haves:
  truths:
    - "Throughput policy activation is queue-pressure-first with named profile presets and per-queue defaults rather than ad-hoc toggles."
    - "Policy state transitions require sustained pressure and cooldown windows, and telemetry failure forces conservative throttling with explicit warning state."
    - "API status contracts expose per-class and per-queue active policy state without regressing existing workflow observability routes."
  artifacts:
    - path: "projects/file_enrichment/file_enrichment/subscriptions/file.py"
      provides: "queue admission/concurrency logic that can consume queue-pressure policy state"
    - path: "projects/document_conversion/document_conversion/workflow_manager.py"
      provides: "policy-aware workflow semaphore behavior with anti-flap transition semantics"
    - path: "projects/web_api/web_api/main.py"
      provides: "throughput policy status/evaluation endpoints and queue-pressure policy wiring"
    - path: "projects/web_api/web_api/models/responses.py"
      provides: "typed API contract models for throughput policy and per-class status"
    - path: "projects/web_api/tests/test_throughput_policy_status.py"
      provides: "regression coverage for policy status contracts and sustained/cooldown behavior"
      min_lines: 80
  key_links:
    - from: "projects/web_api/web_api/main.py"
      to: "projects/web_api/web_api/models/responses.py"
      via: "API handlers return typed throughput-policy response payloads"
    - from: "projects/file_enrichment/file_enrichment/subscriptions/file.py"
      to: "projects/web_api/web_api/main.py"
      via: "queue-pressure policy state produced by runtime is surfaced through API status contract"
    - from: "projects/document_conversion/document_conversion/workflow_manager.py"
      to: "projects/web_api/web_api/main.py"
      via: "document-conversion policy state contributes to consolidated throughput policy status"
    - from: "projects/web_api/tests/test_throughput_policy_status.py"
      to: "projects/web_api/web_api/main.py"
      via: "tests lock API contract and sustained/cooldown transition behavior"
---

<objective>
Implement queue-pressure-first throughput policy behavior with profile presets, sustained+cooldown semantics, fail-safe conservative mode, and API status contracts.

Purpose: satisfy SCALE-01 by making throughput controls measurable and deterministic under queue pressure.
Output: runtime policy behavior + API contracts + regression tests that prove policy transitions.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/07-throughput-controls-workload-policies/07-CONTEXT.md
@.planning/phases/07-throughput-controls-workload-policies/07-RESEARCH.md
@projects/web_api/web_api/main.py
@projects/web_api/web_api/queue_monitor.py
@projects/web_api/web_api/models/responses.py
@projects/file_enrichment/file_enrichment/subscriptions/file.py
@projects/document_conversion/document_conversion/workflow_manager.py
@projects/web_api/tests/test_workflow_observability.py
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Implement queue-pressure trigger and policy-state transitions in runtime workers</name>
  <files>projects/file_enrichment/file_enrichment/subscriptions/file.py, projects/document_conversion/document_conversion/workflow_manager.py, projects/file_enrichment/tests/test_queue_pressure_policies.py, projects/document_conversion/tests/test_workflow_manager_policy.py</files>
  <action>Add policy-aware concurrency/admission controls that consume queue-pressure metrics with profile presets and per-queue defaults, enforce sustained-window activation + cooldown deactivation, and enter conservative fail-safe mode when telemetry is stale/unavailable.</action>
  <verify>cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/test_queue_pressure_policies.py -q && cd /opt/Nemesis/projects/document_conversion && uv run pytest tests/test_workflow_manager_policy.py -q</verify>
  <done>Runtime workers apply deterministic pressure-based throughput policy with anti-flap transitions and fail-safe fallback.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Add throughput policy status/evaluation API contracts</name>
  <files>projects/web_api/web_api/main.py, projects/web_api/web_api/models/responses.py, projects/web_api/tests/test_throughput_policy_status.py, projects/web_api/tests/test_workflow_observability.py</files>
  <action>Extend web_api response models and routes to publish throughput-policy status (active preset, per-queue thresholds, per-class state, sustained/cooldown timing, fail-safe warning reason) while keeping existing observability summary and alert behavior backward compatible.</action>
  <verify>cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_workflow_observability.py tests/test_throughput_policy_status.py -q</verify>
  <done>Operators can query throughput-policy status via API with typed contracts and no regressions to current observability endpoints.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Lock SCALE-01 behavior with cross-service regression verification</name>
  <files>projects/web_api/tests/test_throughput_policy_status.py, projects/file_enrichment/tests/test_queue_pressure_policies.py, projects/document_conversion/tests/test_workflow_manager_policy.py</files>
  <action>Add regression cases that prove queue-pressure-first activation, sustained/cooldown handling, and telemetry-failure conservative fallback across web_api, file_enrichment, and document_conversion policy paths.</action>
  <verify>cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_throughput_policy_status.py -q && cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/test_queue_pressure_policies.py -q && cd /opt/Nemesis/projects/document_conversion && uv run pytest tests/test_workflow_manager_policy.py -q</verify>
  <done>SCALE-01 policy guarantees are test-backed across API and runtime services.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_workflow_observability.py tests/test_throughput_policy_status.py -q` passes
- [ ] `cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/test_queue_pressure_policies.py -q` passes
- [ ] `cd /opt/Nemesis/projects/document_conversion && uv run pytest tests/test_workflow_manager_policy.py -q` passes
- [ ] `cd /opt/Nemesis && rg -n "throughput|policy|sustained|cooldown|fail-safe|queue" projects/web_api/web_api/main.py projects/web_api/web_api/models/responses.py projects/file_enrichment/file_enrichment/subscriptions/file.py projects/document_conversion/document_conversion/workflow_manager.py` confirms policy contract wiring
- [ ] SCALE-01 evidence recorded: operators can apply partitioned throughput controls with measurable queue-pressure policy state
</verification>

<success_criteria>

- SCALE-01 is satisfied with queue-pressure-first throughput policy behavior and measurable policy state exposure
- Sustained/cooldown anti-flap behavior and conservative telemetry-failure fallback are deterministic and test-locked
- Phase scope remains API + runtime worker internals only (no frontend/dashboard additions)

</success_criteria>

<output>
After completion, create `.planning/phases/07-throughput-controls-workload-policies/07-01-SUMMARY.md`
</output>
