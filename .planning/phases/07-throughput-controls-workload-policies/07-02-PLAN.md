---
phase: 07-throughput-controls-workload-policies
plan: 02
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - tools/nemesis-ctl.sh
  - tools/tests/test_throughput_policy_controls.sh
  - docs/performance.md
  - docs/troubleshooting.md
  - docs/usage_guide.md
  - projects/file_enrichment/tests/benchmarks/README.md
  - projects/file_enrichment/tests/benchmarks/bench_basic_analysis.py
files-modified: [tools/nemesis-ctl.sh, tools/tests/test_throughput_policy_controls.sh, docs/performance.md, docs/troubleshooting.md, docs/usage_guide.md, projects/file_enrichment/tests/benchmarks/README.md, projects/file_enrichment/tests/benchmarks/bench_basic_analysis.py]
autonomous: true
objective: "Deliver tiered workload-class throttling operator controls (preset + TTL override + status) with deterministic acceptance-evidence and rollback gates."
requirements:
  - SCALE-02
user_setup: []
must_haves:
  truths:
    - "Operators can control tiered workload throttling through named presets and time-bounded overrides via CLI + API control path."
    - "Policy status output includes concise system summary and per-class active state so expensive-class throttling is operationally visible."
    - "Acceptance requires benchmark compare + queue-drain metrics + operator status snapshots with mandatory rollback triggers and explicit revert path."
  artifacts:
    - path: "tools/nemesis-ctl.sh"
      provides: "operator control/status commands for throughput policy presets and TTL overrides"
    - path: "tools/tests/test_throughput_policy_controls.sh"
      provides: "deterministic validation gate for control commands, docs alignment, and rollback contract"
      min_lines: 50
    - path: "docs/performance.md"
      provides: "benchmark and queue-drain evidence runbook with rollback trigger definitions"
      min_lines: 120
    - path: "docs/troubleshooting.md"
      provides: "incident triage/rollback sequence that includes throughput policy controls"
      min_lines: 120
    - path: "docs/usage_guide.md"
      provides: "operator-facing CLI/API control workflow for throughput policy"
      min_lines: 220
    - path: "projects/file_enrichment/tests/benchmarks/README.md"
      provides: "repeatable stress profile and compare workflow instructions"
  key_links:
    - from: "tools/nemesis-ctl.sh"
      to: "projects/web_api/web_api/main.py"
      via: "CLI control commands call throughput-policy API status/control endpoints"
    - from: "tools/tests/test_throughput_policy_controls.sh"
      to: "tools/nemesis-ctl.sh"
      via: "gate script validates control/status command behavior and required flags"
    - from: "docs/performance.md"
      to: "projects/file_enrichment/tests/benchmarks/README.md"
      via: "evidence contract references repeatable benchmark baseline/compare workflow"
    - from: "docs/troubleshooting.md"
      to: "docs/usage_guide.md"
      via: "triage and rollback runbooks remain aligned for operator execution"
---

<objective>
Deliver tiered workload-class throttling operator controls (preset + TTL override + status) with deterministic acceptance-evidence and rollback gates.

Purpose: satisfy SCALE-02 by ensuring expensive workload classes are throttled without starving baseline responsiveness.
Output: CLI/API control path + deterministic control gate + evidence/rollback runbooks.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/07-throughput-controls-workload-policies/07-CONTEXT.md
@.planning/phases/07-throughput-controls-workload-policies/07-RESEARCH.md
@.planning/phases/07-throughput-controls-workload-policies/07-01-PLAN.md
@tools/nemesis-ctl.sh
@tools/test.sh
@docs/performance.md
@docs/troubleshooting.md
@docs/usage_guide.md
@projects/file_enrichment/tests/benchmarks/README.md
@projects/file_enrichment/tests/benchmarks/bench_basic_analysis.py
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Add throughput-policy operator controls to nemesis-ctl</name>
  <files>tools/nemesis-ctl.sh</files>
  <action>Add deterministic throughput-policy command surface for named presets, TTL-bound overrides, and status inspection that reports concise summary plus per-class active policy state using API-backed calls.</action>
  <verify>cd /opt/Nemesis && rg -n "throughput|preset|override|ttl|status" tools/nemesis-ctl.sh</verify>
  <done>Operators can apply and inspect workload throttling policy modes via a stable CLI control path.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Add deterministic policy control/evidence gate script</name>
  <files>tools/tests/test_throughput_policy_controls.sh</files>
  <action>Create a shell gate that validates policy-control command presence, docs/API command alignment, acceptance evidence checklist terms, and mandatory rollback trigger/revert entries.</action>
  <verify>cd /opt/Nemesis && bash tools/tests/test_throughput_policy_controls.sh</verify>
  <done>Phase 7 operator-control scope and rollback contract are continuously enforceable with one deterministic command.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Publish acceptance evidence and rollback runbooks for throughput policy operations</name>
  <files>docs/performance.md, docs/troubleshooting.md, docs/usage_guide.md, projects/file_enrichment/tests/benchmarks/README.md, projects/file_enrichment/tests/benchmarks/bench_basic_analysis.py</files>
  <action>Document repeatable stress profile workflow, benchmark baseline/compare steps, queue-drain metric collection, policy-status snapshot requirements, pass/fail interpretation, and explicit rollback triggers with revert commands.</action>
  <verify>cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/benchmarks/bench_basic_analysis.py --benchmark-only && cd /opt/Nemesis && rg -n "benchmark-compare|queue-drain|status snapshot|rollback|revert" docs/performance.md docs/troubleshooting.md docs/usage_guide.md projects/file_enrichment/tests/benchmarks/README.md</verify>
  <done>Operators have one reproducible evidence-and-rollback procedure for throughput policy changes under high-volume load.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd /opt/Nemesis && bash tools/tests/test_throughput_policy_controls.sh` passes
- [ ] `cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/benchmarks/bench_basic_analysis.py --benchmark-only` passes
- [ ] `cd /opt/Nemesis && rg -n "throughput|preset|override|ttl|status" tools/nemesis-ctl.sh` confirms CLI control surface
- [ ] `cd /opt/Nemesis && rg -n "benchmark-compare|queue-drain|status snapshot|rollback|revert" docs/performance.md docs/troubleshooting.md docs/usage_guide.md projects/file_enrichment/tests/benchmarks/README.md` confirms evidence + rollback contract
- [ ] SCALE-02 evidence recorded: expensive workloads are policy-throttled with anti-starvation guard and operator-visible state
</verification>

<success_criteria>

- SCALE-02 is satisfied by tiered workload throttling controls with minimum expensive-class floor and operator override lifecycle
- Acceptance evidence bundle (benchmark + queue + status) is deterministic and command-backed
- Rollback triggers and explicit revert path are documented and enforced by deterministic gate

</success_criteria>

<output>
After completion, create `.planning/phases/07-throughput-controls-workload-policies/07-02-SUMMARY.md`
</output>
