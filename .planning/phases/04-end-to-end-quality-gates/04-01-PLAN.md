---
phase: 04-end-to-end-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - projects/web_api/tests/conftest.py
  - projects/web_api/tests/test_ingestion_workflow_smoke.py
  - tools/test.sh
  - .github/workflows/ci-fast.yml
  - docs/usage_guide.md
files-modified: [projects/web_api/tests/conftest.py, projects/web_api/tests/test_ingestion_workflow_smoke.py, tools/test.sh, .github/workflows/ci-fast.yml, docs/usage_guide.md]
autonomous: true
objective: "Add an automated backend smoke gate that verifies upload -> workflow correlation -> retrieval behavior so regressions are blocked in CI before merge."
requirements:
  - TEST-01
user_setup: []
must_haves:
  truths:
    - "CI runs a deterministic smoke suite that validates ingestion submission, workflow visibility, and retrieval endpoint behavior."
    - "Smoke checks execute in fast-gate constraints without requiring live Dapr/RabbitMQ dependencies."
  artifacts:
    - path: "projects/web_api/tests/test_ingestion_workflow_smoke.py"
      provides: "end-to-end API contract smoke coverage for upload/workflow/retrieval path"
      min_lines: 80
    - path: "tools/test.sh"
      provides: "dedicated backend smoke invocation path usable in CI"
    - path: ".github/workflows/ci-fast.yml"
      provides: "PR gate step executing backend smoke suite"
  key_links:
    - from: "projects/web_api/tests/test_ingestion_workflow_smoke.py"
      to: "projects/web_api/web_api/main.py"
      via: "tests assert behavior contracts on /files and /workflows endpoints"
    - from: "tools/test.sh"
      to: ".github/workflows/ci-fast.yml"
      via: "CI invokes smoke mode through shared tooling"
---

<objective>
Add an automated backend smoke gate that verifies upload -> workflow correlation -> retrieval behavior so regressions are blocked in CI before merge.

Purpose: satisfy TEST-01 with low-flake, deterministic API contract coverage built on existing web_api test infrastructure.
Output: smoke test module, test runner wiring, and CI gate integration.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04-end-to-end-quality-gates/04-RESEARCH.md
@projects/web_api/web_api/main.py
@projects/web_api/tests/conftest.py
@projects/web_api/tests/test_download_range.py
@projects/web_api/tests/test_workflow_observability.py
@tools/test.sh
@.github/workflows/ci-fast.yml
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Add backend ingestion/workflow/retrieval smoke tests</name>
  <files>projects/web_api/tests/conftest.py, projects/web_api/tests/test_ingestion_workflow_smoke.py</files>
  <action>Create deterministic smoke tests that exercise the critical API path: file submission contract, workflow status/lifecycle correlation fields, and retrieval/download response behavior. Reuse existing no-op lifespan and storage/database stubs to avoid external service flakiness.</action>
  <verify>cd projects/web_api && uv run pytest tests/test_ingestion_workflow_smoke.py tests/test_download_range.py tests/test_workflow_observability.py -q</verify>
  <done>Critical path smoke assertions run reliably in local and CI test environments.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Expose a dedicated smoke mode in shared test tooling</name>
  <files>tools/test.sh</files>
  <action>Add a focused backend smoke flag (for example `--smoke-backend`) that runs only the critical-path smoke subset and exits non-zero on failure. Keep existing default and readiness-contract behavior backward compatible.</action>
  <verify>./tools/test.sh --smoke-backend</verify>
  <done>Backend smoke suite can be invoked via one stable command from CI and local workflows.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Integrate backend smoke gate into CI fast workflow</name>
  <files>.github/workflows/ci-fast.yml, docs/usage_guide.md</files>
  <action>Add a CI fast-gate step that runs backend smoke checks through shared tooling and document the smoke gate command under usage/operations guidance.</action>
  <verify>rg -n "smoke-backend|ingestion.*smoke|Run backend smoke" .github/workflows/ci-fast.yml docs/usage_guide.md</verify>
  <done>PRs are blocked when critical upload->workflow->retrieval smoke contracts regress.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd projects/web_api && uv run pytest tests/test_ingestion_workflow_smoke.py tests/test_download_range.py tests/test_workflow_observability.py -q` passes
- [ ] `./tools/test.sh --smoke-backend` passes
- [ ] `.github/workflows/ci-fast.yml` invokes the backend smoke gate
- [ ] Smoke tests avoid live Dapr/RabbitMQ dependencies by using deterministic test doubles
</verification>

<success_criteria>

- TEST-01 is enforced by an automated smoke gate in CI
- Critical ingestion/workflow/retrieval contracts are explicitly regression-tested
- Smoke checks remain fast and deterministic for pull-request execution

</success_criteria>

<output>
After completion, create `.planning/phases/04-end-to-end-quality-gates/04-01-SUMMARY.md`
</output>
