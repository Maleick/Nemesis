---
phase: 04-end-to-end-quality-gates
plan: 03
type: execute
wave: 3
depends_on:
  - "04-02"
files_modified:
  - libs/common/common/queues.py
  - projects/web_api/tests/test_queue_topic_contracts.py
  - projects/file_enrichment/tests/test_queue_topic_contracts.py
  - projects/alerting/tests/test_queue_topic_contracts.py
  - tools/test.sh
  - .github/workflows/ci-fast.yml
files-modified: [libs/common/common/queues.py, projects/web_api/tests/test_queue_topic_contracts.py, projects/file_enrichment/tests/test_queue_topic_contracts.py, projects/alerting/tests/test_queue_topic_contracts.py, tools/test.sh, .github/workflows/ci-fast.yml]
autonomous: true
objective: "Add queue/topic/payload contract tests across producers and consumers so pubsub drift is detected automatically in CI."
requirements:
  - TEST-04
user_setup: []
must_haves:
  truths:
    - "Canonical queue/topic contracts are test-validated against producer and consumer wiring across web_api, file_enrichment, and alerting."
    - "CI fast gate fails when topic names, pubsub bindings, or payload compatibility drift from contract expectations."
  artifacts:
    - path: "projects/web_api/tests/test_queue_topic_contracts.py"
      provides: "web_api producer/subscriber contract assertions"
      min_lines: 80
    - path: "projects/file_enrichment/tests/test_queue_topic_contracts.py"
      provides: "file_enrichment topic consumer/publisher compatibility assertions"
      min_lines: 80
    - path: "projects/alerting/tests/test_queue_topic_contracts.py"
      provides: "alerting subscriber contract assertions"
      min_lines: 50
    - path: "tools/test.sh"
      provides: "contract-test mode for queue/topic validation"
  key_links:
    - from: "libs/common/common/queues.py"
      to: "projects/web_api/tests/test_queue_topic_contracts.py"
      via: "tests validate runtime usage against canonical constants"
    - from: "projects/file_enrichment/tests/test_queue_topic_contracts.py"
      to: "projects/file_enrichment/file_enrichment/controller.py"
      via: "contract tests assert subscription/topic mapping compatibility"
    - from: "tools/test.sh"
      to: ".github/workflows/ci-fast.yml"
      via: "CI invokes queue contract gate through shared test script"
---

<objective>
Add queue/topic/payload contract tests across producers and consumers so pubsub drift is detected automatically in CI.

Purpose: satisfy TEST-04 by converting currently implicit queue wiring assumptions into explicit, failing-fast regression tests.
Output: contract test suites, optional canonical queue metadata helper updates, and CI gate integration.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04-end-to-end-quality-gates/04-RESEARCH.md
@.planning/phases/04-end-to-end-quality-gates/04-02-PLAN.md
@libs/common/common/queues.py
@projects/web_api/web_api/main.py
@projects/file_enrichment/file_enrichment/controller.py
@projects/file_enrichment/file_enrichment/workflow_completion.py
@projects/file_enrichment/file_enrichment/activities/publish_findings.py
@projects/alerting/alerting/main.py
@tools/test.sh
@.github/workflows/ci-fast.yml
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Define and expose canonical queue/topic contract metadata</name>
  <files>libs/common/common/queues.py</files>
  <action>Add structured contract metadata and helper accessors (without breaking existing constants) so tests can validate producer/consumer wiring from one canonical source of truth.</action>
  <verify>cd libs/common && uv run pytest tests/ -q</verify>
  <done>Queue contract metadata is centrally available for multi-service contract tests.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Add queue/topic/payload contract tests per service boundary</name>
  <files>projects/web_api/tests/test_queue_topic_contracts.py, projects/file_enrichment/tests/test_queue_topic_contracts.py, projects/alerting/tests/test_queue_topic_contracts.py</files>
  <action>Create targeted tests that assert expected topic constants, publish/subscribe endpoint wiring, and minimal payload-shape compatibility assumptions for critical cross-service queues.</action>
  <verify>cd projects/web_api && uv run pytest tests/test_queue_topic_contracts.py -q && cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/test_queue_topic_contracts.py -q && cd /opt/Nemesis/projects/alerting && uv run pytest tests/test_queue_topic_contracts.py -q</verify>
  <done>Contract drift in queue/topic/payload wiring fails tests in the owning service suites.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Enforce queue contract checks in shared tooling and CI fast gate</name>
  <files>tools/test.sh, .github/workflows/ci-fast.yml</files>
  <action>Add a dedicated queue-contract mode in shared test tooling and wire it into `ci-fast.yml` so pull requests fail on queue contract regressions.</action>
  <verify>./tools/test.sh --queue-contract</verify>
  <done>Queue contract validation is consistently enforced in PR quality gates.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd projects/web_api && uv run pytest tests/test_queue_topic_contracts.py -q` passes
- [ ] `cd projects/file_enrichment && uv run pytest tests/test_queue_topic_contracts.py -q` passes
- [ ] `cd projects/alerting && uv run pytest tests/test_queue_topic_contracts.py -q` passes
- [ ] `./tools/test.sh --queue-contract` passes
- [ ] `.github/workflows/ci-fast.yml` executes queue contract checks
</verification>

<success_criteria>

- TEST-04 is protected by explicit queue/topic/payload contract tests
- Producer/consumer drift is caught in CI before merge
- Contract checks are maintainable via centralized queue metadata

</success_criteria>

<output>
After completion, create `.planning/phases/04-end-to-end-quality-gates/04-03-SUMMARY.md`
</output>
