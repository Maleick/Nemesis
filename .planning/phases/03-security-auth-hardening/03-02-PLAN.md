---
phase: 03-security-auth-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - projects/agents/agents/auth_provider.py
  - projects/agents/agents/model_manager.py
  - projects/agents/agents/tasks/chatbot.py
  - projects/agents/agents/main.py
  - projects/web_api/web_api/main.py
  - projects/agents/tests/test_auth_provider_auth_json.py
  - projects/agents/tests/test_auth_provider_expiry.py
  - projects/agents/tests/test_chatbot_preflight.py
  - projects/agents/tests/test_model_manager_modes.py
  - projects/web_api/tests/test_llm_auth_status.py
  - projects/agents/tests/test_auth_mode_contract.py
files-modified: [projects/agents/agents/auth_provider.py, projects/agents/agents/model_manager.py, projects/agents/agents/tasks/chatbot.py, projects/agents/agents/main.py, projects/web_api/web_api/main.py, projects/agents/tests/test_auth_provider_auth_json.py, projects/agents/tests/test_auth_provider_expiry.py, projects/agents/tests/test_chatbot_preflight.py, projects/agents/tests/test_model_manager_modes.py, projects/web_api/tests/test_llm_auth_status.py, projects/agents/tests/test_auth_mode_contract.py]
autonomous: true
objective: "Tighten auth-mode misconfiguration behavior and chatbot DB credential preflight determinism so health/status surfaces are explicit, testable, and remediation-focused."
requirements:
  - SEC-02
  - SEC-03
user_setup: []
must_haves:
  truths:
    - "Auth-mode misconfiguration produces explicit unhealthy/degraded status with remediation-oriented messaging instead of ambiguous fallback behavior."
    - "Chatbot DB credential preflight failures are deterministic, categorized, and test-protected without leaking secret values."
  artifacts:
    - path: "projects/agents/agents/auth_provider.py"
      provides: "deterministic auth-mode resolution outcomes and structured unhealthy reasons"
      min_lines: 60
    - path: "projects/agents/agents/tasks/chatbot.py"
      provides: "deterministic chatbot DB preflight classification and safe startup error signaling"
    - path: "projects/web_api/web_api/main.py"
      provides: "stable `/system/llm-auth-status` fallback/degraded behavior for operator surfaces"
    - path: "projects/agents/tests/test_auth_mode_contract.py"
      provides: "auth-mode contract regression coverage for supported/misconfigured modes"
  key_links:
    - from: "projects/agents/agents/auth_provider.py"
      to: "projects/agents/agents/model_manager.py"
      via: "resolved auth health/message semantics propagate to runtime model availability status"
    - from: "projects/agents/agents/main.py"
      to: "projects/web_api/web_api/main.py"
      via: "agents `/agents/auth-status` contract consumed by web_api `/system/llm-auth-status`"
    - from: "projects/agents/agents/tasks/chatbot.py"
      to: "projects/agents/tests/test_chatbot_preflight.py"
      via: "tests validate deterministic preflight failure messaging and non-secret diagnostics"
---

<objective>
Tighten auth-mode misconfiguration behavior and chatbot DB credential preflight determinism so health/status surfaces are explicit, testable, and remediation-focused.

Purpose: close SEC-02 and SEC-03 by enforcing deterministic auth contract behavior and startup preflight diagnostics for operator workflows.
Output: auth-mode contract hardening, preflight behavior tightening, and expanded regression coverage.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/03-security-auth-hardening/03-RESEARCH.md
@.planning/phases/03-security-auth-hardening/03-01-PLAN.md
@projects/agents/agents/auth_provider.py
@projects/agents/agents/model_manager.py
@projects/agents/agents/tasks/chatbot.py
@projects/agents/agents/main.py
@projects/web_api/web_api/main.py
@projects/agents/tests/test_auth_provider_auth_json.py
@projects/agents/tests/test_auth_provider_expiry.py
@projects/agents/tests/test_chatbot_preflight.py
@projects/agents/tests/test_model_manager_modes.py
@projects/web_api/tests/test_llm_auth_status.py
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Harden auth-mode contract semantics and unhealthy signaling</name>
  <files>projects/agents/agents/auth_provider.py, projects/agents/agents/model_manager.py, projects/agents/agents/main.py, projects/web_api/web_api/main.py</files>
  <action>Ensure invalid/missing/unsupported auth-mode inputs produce deterministic unhealthy status payloads with remediation hints across agents and web_api surfaces while preserving backward-compatible response keys for existing consumers.</action>
  <verify>cd projects/agents && uv run pytest tests/test_auth_provider_auth_json.py tests/test_auth_provider_expiry.py tests/test_model_manager_modes.py -q && cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_llm_auth_status.py -q</verify>
  <done>Operator-visible auth status endpoints consistently report actionable degraded/unhealthy states for configuration drift.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Make chatbot DB credential preflight deterministic and safe</name>
  <files>projects/agents/agents/tasks/chatbot.py, projects/agents/tests/test_chatbot_preflight.py</files>
  <action>Refine chatbot preflight to classify expected credential/connectivity failures deterministically, emit stable remediation text, and avoid leaking sensitive connection material in raised runtime errors and logs.</action>
  <verify>cd projects/agents && uv run pytest tests/test_chatbot_preflight.py -q</verify>
  <done>Chatbot startup failure behavior is deterministic, testable, and secret-safe under credential mismatch and connectivity failure scenarios.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Expand contract-level tests for SEC-02 and SEC-03</name>
  <files>projects/agents/tests/test_auth_mode_contract.py, projects/agents/tests/test_auth_provider_auth_json.py, projects/agents/tests/test_auth_provider_expiry.py, projects/web_api/tests/test_llm_auth_status.py</files>
  <action>Add targeted regression tests for auth-mode misconfiguration outcomes and status payload invariants, including web_api fallback paths and remediation message consistency. Keep assertions focused on deterministic contract semantics rather than implementation details.</action>
  <verify>cd projects/agents && uv run pytest tests/test_auth_mode_contract.py tests/test_auth_provider_auth_json.py tests/test_auth_provider_expiry.py tests/test_model_manager_modes.py tests/test_chatbot_preflight.py -q && cd /opt/Nemesis/projects/web_api && uv run pytest tests/test_llm_auth_status.py -q</verify>
  <done>SEC-02 and SEC-03 behavior is enforced by a stable contract-level regression suite across agents and web_api.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd projects/agents && uv run pytest tests/test_auth_mode_contract.py tests/test_auth_provider_auth_json.py tests/test_auth_provider_expiry.py tests/test_model_manager_modes.py tests/test_chatbot_preflight.py -q` passes
- [ ] `cd projects/web_api && uv run pytest tests/test_llm_auth_status.py -q` passes
- [ ] `/agents/auth-status` and `/system/llm-auth-status` provide explicit unhealthy/degraded status for misconfiguration scenarios
- [ ] Chatbot preflight failure messages are deterministic, remediation-focused, and secret-safe
</verification>

<success_criteria>

- SEC-02 and SEC-03 are fully addressed through explicit, deterministic auth/preflight behavior
- Operator health/status surfaces contain actionable remediation context for auth drift
- Regression tests protect both normal and failure-path auth contracts

</success_criteria>

<output>
After completion, create `.planning/phases/03-security-auth-hardening/03-02-SUMMARY.md`
</output>
