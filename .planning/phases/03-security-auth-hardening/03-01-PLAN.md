---
phase: 03-security-auth-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - libs/common/common/logger.py
  - projects/agents/agents/litellm_startup.py
  - projects/agents/agents/helpers.py
  - projects/agents/agents/main.py
  - projects/agents/agents/tasks/chatbot.py
  - projects/web_api/web_api/main.py
  - projects/alerting/alerting/main.py
  - projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py
  - projects/agents/tests/test_secret_safe_logging.py
  - projects/file_enrichment/tests/test_noseyparker_subscription_security.py
files-modified: [libs/common/common/logger.py, projects/agents/agents/litellm_startup.py, projects/agents/agents/helpers.py, projects/agents/agents/main.py, projects/agents/agents/tasks/chatbot.py, projects/web_api/web_api/main.py, projects/alerting/alerting/main.py, projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py, projects/agents/tests/test_secret_safe_logging.py, projects/file_enrichment/tests/test_noseyparker_subscription_security.py]
autonomous: true
objective: "Enforce secret-safe logging and redaction behavior across core auth paths so startup/runtime failures never emit raw secret literals."
requirements:
  - SEC-01
user_setup: []
must_haves:
  truths:
    - "Startup/runtime auth-path logs no longer emit raw secrets (passwords, tokens, JWT strings, admin-key values, raw sensitive response bodies)."
    - "Error diagnostics remain actionable with deterministic remediation context after redaction hardening."
  artifacts:
    - path: "libs/common/common/logger.py"
      provides: "shared redaction and sanitization helpers consumable by core services"
      min_lines: 40
    - path: "projects/agents/agents/litellm_startup.py"
      provides: "token-provisioning log paths sanitized for secret-safe behavior"
    - path: "projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py"
      provides: "JWT failure logging paths that avoid raw token emission"
    - path: "projects/agents/tests/test_secret_safe_logging.py"
      provides: "regression checks proving secret literals are not logged in auth paths"
  key_links:
    - from: "libs/common/common/logger.py"
      to: "projects/agents/agents/litellm_startup.py"
      via: "service-level use of shared redaction helpers for exception/log payload sanitization"
    - from: "libs/common/common/logger.py"
      to: "projects/alerting/alerting/main.py"
      via: "secret-safe sanitization of startup/runtime alerting error logs"
    - from: "projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py"
      to: "projects/file_enrichment/tests/test_noseyparker_subscription_security.py"
      via: "tests validate JWT decode failure logs never contain raw jwt_token"
---

<objective>
Enforce secret-safe logging and redaction behavior across core auth paths so startup/runtime failures never emit raw secret literals.

Purpose: satisfy SEC-01 without repo-wide scope creep by hardening the highest-risk auth logging surfaces first.
Output: redaction helper upgrades, sanitized logging callsites, and regression tests proving non-leak behavior.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/03-security-auth-hardening/03-RESEARCH.md
@libs/common/common/logger.py
@projects/agents/agents/litellm_startup.py
@projects/agents/agents/helpers.py
@projects/agents/agents/main.py
@projects/agents/agents/tasks/chatbot.py
@projects/web_api/web_api/main.py
@projects/alerting/alerting/main.py
@projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Strengthen shared redaction primitives for auth-path logging</name>
  <files>libs/common/common/logger.py, projects/agents/agents/helpers.py, projects/agents/agents/litellm_startup.py</files>
  <action>Expand and standardize shared sanitization helpers so auth-path logs can safely include operational context while redacting sensitive key/value pairs and trimming untrusted response bodies. Replace direct risky log payload patterns in helpers/startup code with the shared sanitizer.</action>
  <verify>cd projects/agents && uv run pytest tests/test_model_manager_modes.py tests/test_auth_provider_auth_json.py tests/test_auth_provider_expiry.py -q</verify>
  <done>Core logging helper surfaces provide reusable redaction behavior and are adopted in agent auth startup paths.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Sanitize secret-adjacent logs in scoped auth services</name>
  <files>projects/agents/agents/main.py, projects/agents/agents/tasks/chatbot.py, projects/web_api/web_api/main.py, projects/alerting/alerting/main.py, projects/file_enrichment/file_enrichment/subscriptions/noseyparker.py</files>
  <action>Refactor scoped auth-path log statements to remove raw token/password/JWT/response body emissions and replace with deterministic non-secret diagnostics. Preserve remediation value via mode/source/host/port/database context where safe.</action>
  <verify>cd projects/web_api && uv run pytest tests/test_llm_auth_status.py -q</verify>
  <done>Auth-path logs in agents/web_api/alerting/file_enrichment no longer emit raw secret literals while retaining actionable operational signals.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Add regression tests for secret-safe logging guarantees</name>
  <files>projects/agents/tests/test_secret_safe_logging.py, projects/file_enrichment/tests/test_noseyparker_subscription_security.py, projects/agents/tests/test_chatbot_preflight.py</files>
  <action>Add focused tests that force representative auth-path failures and assert secret literals are absent from emitted logs and raised error text. Ensure JWT decode failure paths in NoseyParker never log raw `jwt_token` content.</action>
  <verify>cd projects/agents && uv run pytest tests/test_chatbot_preflight.py tests/test_secret_safe_logging.py -q && cd /opt/Nemesis/projects/file_enrichment && uv run pytest tests/test_noseyparker_subscription_security.py -q</verify>
  <done>Automated regression coverage enforces secret-safe logging behavior for scoped SEC-01 paths.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd projects/agents && uv run pytest tests/test_chatbot_preflight.py tests/test_auth_provider_auth_json.py tests/test_auth_provider_expiry.py tests/test_model_manager_modes.py tests/test_secret_safe_logging.py -q` passes
- [ ] `cd projects/web_api && uv run pytest tests/test_llm_auth_status.py -q` passes
- [ ] `cd projects/file_enrichment && uv run pytest tests/test_noseyparker_subscription_security.py -q` passes
- [ ] No auth-path log/error string contains raw secret literals for forced failure scenarios
</verification>

<success_criteria>

- Core auth-path startup/runtime logging is secret-safe under nominal and failure conditions
- Redaction/sanitization behavior is centralized enough to prevent recurring ad-hoc leak patterns
- SEC-01 is demonstrably enforced by regression tests

</success_criteria>

<output>
After completion, create `.planning/phases/03-security-auth-hardening/03-01-SUMMARY.md`
</output>
