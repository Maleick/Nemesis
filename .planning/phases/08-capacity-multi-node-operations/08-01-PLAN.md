---
phase: 08-capacity-multi-node-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tools/nemesis-ctl.sh
  - tools/tests/test_nemesis_ctl_profiles.sh
  - tools/tests/test_capacity_profile_contracts.sh
  - tools/test.sh
files-modified: [tools/nemesis-ctl.sh, tools/tests/test_nemesis_ctl_profiles.sh, tools/tests/test_capacity_profile_contracts.sh, tools/test.sh]
autonomous: true
objective: "Establish deterministic operator capacity-profile controls and validation gates for multi-node scale workflows."
requirements:
  - SCALE-03
user_setup: []
must_haves:
  truths:
    - "Operators can select and validate capacity profiles through a stable `nemesis-ctl` contract instead of ad-hoc compose command assembly."
    - "Capacity profile validation is deterministic and executable in local and CI contexts via dedicated test scripts and `tools/test.sh` flag wiring."
    - "Capacity controls remain aligned with current compose/runtime behavior without direct infrastructure YAML rewrites."
  artifacts:
    - path: "tools/nemesis-ctl.sh"
      provides: "capacity profile control/status command contract with strict argument validation"
    - path: "tools/tests/test_capacity_profile_contracts.sh"
      provides: "deterministic capacity runbook contract gate"
      min_lines: 60
    - path: "tools/tests/test_nemesis_ctl_profiles.sh"
      provides: "expanded profile smoke coverage including capacity contract expectations"
    - path: "tools/test.sh"
      provides: "standardized --capacity-contract gate wrapper for local and CI use"
  key_links:
    - from: "tools/test.sh"
      to: "tools/tests/test_capacity_profile_contracts.sh"
      via: "test harness delegates capacity contract checks through one stable command"
    - from: "tools/nemesis-ctl.sh"
      to: "tools/tests/test_nemesis_ctl_profiles.sh"
      via: "profile/capacity command behavior is regression-locked by smoke tests"
    - from: "tools/nemesis-ctl.sh"
      to: "tools/tests/test_capacity_profile_contracts.sh"
      via: "capacity runbook command surface is enforced by deterministic rg assertions"
---

<objective>
Establish deterministic operator capacity-profile controls and validation gates for multi-node scale workflows.

Purpose: satisfy SCALE-03 foundation by making capacity profile operations executable and testable before expanding docs/CI wiring.
Output: nemesis-ctl capacity-profile command contract + deterministic tests + test.sh gate integration.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/08-capacity-multi-node-operations/08-RESEARCH.md
@tools/nemesis-ctl.sh
@tools/tests/test_nemesis_ctl_profiles.sh
@tools/test.sh
@compose.yaml
@compose.prod.build.yaml
</context>

<tasks>

## Task 1
<task type="auto">
  <name>Task 1: Add capacity-profile control contract to nemesis-ctl</name>
  <files>tools/nemesis-ctl.sh</files>
  <action>Add a deterministic capacity-profile operator surface that validates profile mode and emits executable start/status guidance for baseline, observability, and scale-out workflows while preserving existing start/stop/clean behavior.</action>
  <verify>cd /opt/Nemesis && rg -n "capacity|profile|scale-out|validate|status" tools/nemesis-ctl.sh</verify>
  <done>Operators can invoke one `nemesis-ctl` capacity contract path and receive profile-consistent, executable guidance for multi-node readiness validation.</done>
</task>

## Task 2
<task type="auto">
  <name>Task 2: Add deterministic capacity contract tests and extend profile smoke coverage</name>
  <files>tools/tests/test_capacity_profile_contracts.sh, tools/tests/test_nemesis_ctl_profiles.sh</files>
  <action>Create a dedicated capacity contract test that validates command surface and compose/profile alignment, and extend existing nemesis-ctl smoke tests to cover the new capacity profile contract behavior.</action>
  <verify>cd /opt/Nemesis && bash tools/tests/test_nemesis_ctl_profiles.sh && bash tools/tests/test_capacity_profile_contracts.sh</verify>
  <done>Profile and capacity contract behavior is enforced by repeatable shell tests with no dependency on live containers.</done>
</task>

## Task 3
<task type="auto">
  <name>Task 3: Expose a first-class capacity contract gate in tools/test.sh</name>
  <files>tools/test.sh</files>
  <action>Add a dedicated `--capacity-contract` mode to `tools/test.sh` that delegates to the capacity contract script and follows the existing guard style used by readiness/smoke/queue contract modes.</action>
  <verify>cd /opt/Nemesis && ./tools/test.sh --capacity-contract</verify>
  <done>Operators and CI can run one stable command to verify capacity runbook contract alignment.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd /opt/Nemesis && bash tools/tests/test_nemesis_ctl_profiles.sh` passes
- [ ] `cd /opt/Nemesis && bash tools/tests/test_capacity_profile_contracts.sh` passes
- [ ] `cd /opt/Nemesis && ./tools/test.sh --capacity-contract` passes
- [ ] `cd /opt/Nemesis && rg -n "capacity|profile|scale-out|validate|status" tools/nemesis-ctl.sh tools/tests/test_capacity_profile_contracts.sh tools/test.sh` confirms contract wiring
- [ ] SCALE-03 foundation evidence recorded: deterministic capacity profile control path and validation gate exist
</verification>

<success_criteria>

- SCALE-03 operator contract foundation exists in tooling with deterministic validation
- Capacity contract checks can run both directly and via `tools/test.sh --capacity-contract`
- No direct infra YAML edits are required for this foundation wave

</success_criteria>

<output>
After completion, create `.planning/phases/08-capacity-multi-node-operations/08-01-SUMMARY.md`
</output>
